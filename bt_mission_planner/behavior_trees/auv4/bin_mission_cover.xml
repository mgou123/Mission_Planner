<?xml version="1.0"?>
<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <Sequence>
            <Action ID="ControllerService" enable="true" service_name="/auv4/controller"/>
            <!-- <SetBlackboard output_key="vision_topic" value="/auv4/vision/external/detected"/>
            <SetBlackboard output_key="pose_topic_name" value="/auv4/nav/odom_ned"/> -->
            <SetBlackboard output_key="trial_dis" value="0.6"/>
            <SetBlackboard output_key="lift_ratio_x" value="0.7"/>
            <SetBlackboard output_key="lift_ratio_y" value="0.5"/>
            <Action ID="DetectorAUVService" objects="bin" service_name="/auv4/vision/detector"/>
            
            <!-- Move in spiral until seeing one lid -->
            <ReactiveFallback>
                <Sequence>
                    <Action ID="UpdateDetectedObjects" queue_size="" result="vision_detected" timeout_sec="" topic_name="{vision_topic}"/>
                    <Condition ID="IsLidSeen" lid_num="1" vision_objects="{vision_detected}"/>
                </Sequence>
                <Repeat num_cycles="50">
                    <Sequence>
                        <Action ID="NavigateControl" depth="0.3" forward="{trial_dis}" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0.0" yaw="0.0"/>
                        <Action ID="NavigateControl" depth="0.3" forward="0.0" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0.0" yaw="60"/>
                        <Action ID="Adder" orig_value="{trial_dis}" result="{trial_dis}" value_added="0.2"/>
                    </Sequence>
                </Repeat>
            </ReactiveFallback>

            <!-- ensure that a full handle is in sight -->
            <Action ID="CalcPicAngle" pic_identifier="Lid" ratio="0.001" vision_objects="{vision_detected}" x_goal="go_pic_x" y_goal="go_pic_y" yaw_goal="go_pic_yaw"/>
            
            <!-- turn until handle is horizontal -->
            <ReactiveFallback>
                <Action ID="IsHandleFlat" vision_objects="{vision_detected}" flat_ratio="0.2"/>
                <Action ID="NavigateControl" depth="0.3" forward="0.0" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0.0" yaw="180"/>
            </ReactiveFallback>
            
            <!-- adjust position until a full bin is seen -->
            <ReactiveFallback>
                <Action ID="IsFullBinSeen" vision_objects="{vision_detected}" area_benchmark="1000"/>
                <Sequence>
                    <Action ID="NavigateControl" depth="0.3" forward="0.3" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0.0" yaw="0"/>
                    <Action ID="NavigateControl" depth="0.3" forward="0.4" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0.0" yaw="0"/>
                    <Action ID="NavigateControl" depth="0.3" forward="-0.6" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0.0" yaw="0"/>
                    <Action ID="NavigateControl" depth="0.3" forward="-0.8" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0.0" yaw="0"/>
                    <Action ID="NavigateControl" depth="0.3" forward="0.6" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0.0" yaw="0"/>
                    <Action ID="NavigateControl" depth="0.3" forward="0.4" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0.0" yaw="0"/>
                </Sequence>
            </ReactiveFallback>
            <Action ID="UpdatePose" topic_name="/auv4/nav/odom_ned" result="center_pose_odom" depth="center_depth"/>
            <Action ID="ConvertOdomToPose" odom_pose="{center_pose_odom}" pose="{center_pose}"/>

            <!--lift and drop covers one by one--> 
            <Action ID="CalcCoverSetpoint" vision_objects="{vision_detected}" ratio="0.005" lift_ratio_x="{lift_fratio_x}" lift_ratio_y="{lift_ratio_y}" pre_="0" 
                lift_pose_1_x="drop_pose_1_x" lift_pose_1_y="drop_pose_1_y" drop_pose_1="drop_pose_1">
            <Action ID="NavigateControl" depth="1.6" forward="drop_1_pose_y" server_name="/auv4/LocomotionServer" server_timeout="" sideways="drop_1_pose_x" yaw="0"/>
            <Action ID="ManipulatorsService" service_name="/auv4/manipulators" top_torpedo="false" bottom_torpedo="false" dropper="false" grabber="false" 
                extend_linear="false" retract_linear="true"/>
            <Action ID="NavigateControl" depth="0.3" forward="0" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0" yaw="0"/>
            <Action ID="NavigateControl" depth="0.3" forward="drop_pose_1" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0" yaw="0"/>
            <Action ID="ManipulatorsService" service_name="/auv4/manipulators" top_torpedo="false" bottom_torpedo="false" dropper="false" grabber="false" 
                extend_linear="true" retract_linear="false"/>
            
            <NavigateToPose server_name="/auv4/LocomotionServer" goal="{center_pose_odom}" relative="false" depth_lock="0.3"/>
            <Action ID="CalcCoverSetpoint" vision_objects="{vision_detected}" ratio="0.005" lift_ratio_x="{lift_ratio_x}" lift_ratio_y="{lift_ratio_y}" pre_direction="{drop_Pose_1}" 
                lift_pose_1_x="drop_pose_2_x" lift_pose_1_y="drop_pose_2_y" drop_pose_1="drop_pose_2">
            <Action ID="NavigateControl" depth="1.6" forward="drop_1_pose_y" server_name="/auv4/LocomotionServer" server_timeout="" sideways="drop_1_pose_x" yaw="0"/>
            <Action ID="ManipulatorsService" service_name="/auv4/manipulators" top_torpedo="false" bottom_torpedo="false" dropper="false" grabber="false" 
                extend_linear="false" retract_linear="true"/>
            <Action ID="NavigateControl" depth="0.3" forward="0" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0" yaw="0"/>
            <Action ID="NavigateControl" depth="0.3" forward="drop_pose_2" server_name="/auv4/LocomotionServer" server_timeout="" sideways="0" yaw="0"/>
            <Action ID="ManipulatorsService" service_name="/auv4/manipulators" top_torpedo="false" bottom_torpedo="false" dropper="false" grabber="false" 
                extend_linear="true" retract_linear="false"/>
            <NavigateToPose server_name="/auv4/LocomotionServer" goal="{center_pose_odom}" relative="false" depth_lock="0.3"/>

            <!--choose a picture to drop the ball -->
            <Action ID="ChoosePic" pic_identifier="pic" gate_side="Gman" vision_objects="{vision_detected}"/>
            <ReactiveFallback>
                <Sequence>
                    <Action ID="UpdateDetectedObjects" queue_size="" result="{vision_detected}" timeout_sec="" topic_name="{vision_topic}"/>
                    <Condition ID="IsCenterAligned" pic_identifier="{pic}" vision_objects="{vision_detected}" center_offset_x="30" center_offset_y="30" x_ratio="0.4" y_ratio="0.5"/>
                </Sequence>
                <Sequence>
                    <Action ID="CalcPicAngle" pic_identifier="{pic}" ratio="0.005" vision_objects="{vision_detected}" x_goal="go_pic_x" y_goal="go_pic_y" yaw_goal="go_pic_yaw"/>
                    <Action ID="NavigateControl" depth="0.3" forward="{go_pic_y}" server_name="/auv4/LocomotionServer" server_timeout="" sideways="{go_pic_x}" yaw="{go_pic_yaw}"/>
                </Sequence>
            </ReactiveFallback>
            <Action ID="NavigateToPose" depth_lock="" goal="0;0;1.1;0" relative="true" server_name="/auv4/LocomotionServer" server_timeout="" yaw_lock=""/>
            <Action ID="ManipulatorsService" service_name="/auv4/manipulators" top_torpedo="false" bottom_torpedo="false" dropper="true" grabber="false" extend_linear="false" retract_linear="false"/>
        </Sequence>
    </BehaviorTree>
</root>
