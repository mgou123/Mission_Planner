<root main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <Sequence>
      <ControllerService service_name="/auv3/controller" enable="true"/>
      <SetBlackboard output_key="pose_topic_name" value="/auv3/nav/odom_ned"/>

      <SubTree ID="Gate" node="node" goal="goal" pose_topic_name="pose_topic_name"/>
      <NavigateToPose server_name="/auv3/LocomotionServer" goal="4;0;0.8;0" relative="true"/>
      <SubTree ID="Buoy" node="node" goal="goal" pose_topic_name="pose_topic_name"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Gate">
      <Sequence>      
      <ReactiveFallback>
        <IsTimeExpired seconds="10"/>
        <NavigateToPose server_name="/auv3/LocomotionServer" goal="0;0;0.8;0" relative="true"/>
      </ReactiveFallback>

      <UpdatePose topic_name="{pose_topic_name}" result="{odom_pose}"/>
      <ConvertOdomToPose odom_pose="{odom_pose}" pose="{pose}" />
      
      <ReactiveSequence>
        <UpdatePose topic_name="{pose_topic_name}" result="{odom_pose}"/>
        <ConvertOdomToPose odom_pose="{odom_pose}" pose="{pose}" />
        <NavigateToPose server_name="/auv3/LocomotionServer" goal="1;0;0.8;0" relative="true"/>
        <NavigateToPose server_name="/auv3/LocomotionServer" goal="0;-1;0.8;0" relative="true"/>
        <NavigateToPose server_name="/auv3/LocomotionServer" goal="2;0;0.8;0" relative="true"/>
        <Repeat num_cycles="4">
          <ReactiveFallback>
            <IsTimeExpired seconds="6"/>
            <NavigateToPose server_name="/auv3/LocomotionServer" goal="0;0;0.8;90" relative="true"/>
          </ReactiveFallback>
        </Repeat>
      </ReactiveSequence>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Buoy">
    <Sequence>
      <!-- Hopefully it finds the object... -->
      <RetryUntilSuccesful num_attempts="-1">
        <UpdateDetectedObjects topic_name="/auv3/vision/detected" objects="vision_detected" />
      </RetryUntilSuccesful>
      <FindBuoy vision_objects="{vision_detected}" target_identity="badge" forward="{forward}" sideways="{sideways}" depth="{depth}" yaw="{yaw}"/>
  
      <!-- Move Yaw-->
      <NavigateControl server_name="/auv3/LocomotionServer" forward="0.0" sideways="0.0" depth="0.7" yaw="{yaw}"/>

      <RetryUntilSuccesful num_attempts="-1">
        <UpdateDetectedObjects topic_name="/auv3/vision/detected" objects="vision_detected" />
      </RetryUntilSuccesful>
      <FindBuoy vision_objects="{vision_detected}" target_identity="badge" forward="{forward}" sideways="{sideways}" depth="{depth}" yaw="{yaw}"/>
      
      <!-- Move Forward -->
      <NavigateControl server_name="/auv3/LocomotionServer" forward="{forward}" sideways="{sideways}" depth="0.7" yaw="0"/>
    </Sequence>
  </BehaviorTree>
</root>