<root main_tree_to_execute = "TorpedoTaskTree" >
  <include ros_pkg="bt_mission_planner" path="behavior_trees/side_sweep_sim.xml"/>
  <BehaviorTree ID="TorpedoTaskTree">
    <Sequence>
      <SetBlackboard output_key="vision_main_target" value="bootlegger"/>
      <SetBlackboard output_key="vision_target" value="bootlegger_small_hole"/>
      <DetectorAUVService service_name="{vision_service_name}" objects="bootlegger_small_hole,bootlegger" enable="true"/>

      <UpdatePose topic_name="{pose_topic_name}" result="{odom_pose}" depth="{standard_depth}"/>
      <ConvertOdomToPose odom_pose="{odom_pose}" pose="{pose}" />
      <SplitPoseComponents pose="{pose}" yaw="{temp_yaw}" />

      <SetBlackboard output_key="object_yaw" value="0" />
      <SetBlackboard output_key="goal" value="0;0" />

      <!-- Find vision_main_target -->
      <ReactiveFallback>
        <Sequence>
            <UpdateDetectedObjects topic_name="{vision_topic_name}" result="{detected_objects}" timeout_sec="10.0" />
            <SetObjectGoal vision_objects="{detected_objects}" target_identity="{vision_main_target}" goal="{goal}" absolute_depth="{object_depth}" absolute_yaw="{object_yaw}" />
        </Sequence>
        <SubTree ID="SideSweepTree" node="node" server_name="server_name" original_yaw="{object_yaw}" depth="standard_depth" />
      </ReactiveFallback>

      <!-- Align with vision_main_target -->
      <RetryUntilSuccesful num_attempts="-1">
        <Sequence>
          <UpdateDetectedObjects topic_name="{vision_topic_name}" result="{detected_objects}" timeout_sec="10.0" />
          <SetObjectGoal vision_objects="{detected_objects}" target_identity="{vision_main_target}" goal="{goal}" absolute_depth="{object_depth}" absolute_yaw="{object_yaw}" />
        </Sequence>
      </RetryUntilSuccesful>
      <ModifyGoal original_pose="{goal}" zeroed_components="x" final_pose="{goal}"/>
      <NavigateToPose server_name="{server_name}" goal="{goal}" yaw_lock="{object_yaw}" depth_lock="{standard_depth}"/>

      <!-- Find vision_main_target's Small Hole -->
      <!-- <RetryUntilSuccesful num_attempts="-1"> -->
        <!-- <Sequence> -->
          <!-- <UpdateDetectedObjects topic_name="{vision_topic_name}" result="{detected_objects}" timeout_sec="10.0" /> -->
          <!-- <SetObjectGoal vision_objects="{detected_objects}" target_identity="{vision_target}" goal="{goal}" absolute_depth="{object_depth}" absolute_yaw="{object_yaw}" /> -->
        <!-- </Sequence> -->
      <!-- </RetryUntilSuccesful> -->

      <!-- Align with vision_main_target's Small Hole (Hardcoded Values)-->
      <!-- <ModifyGoal original_pose="{goal}" zeroed_components="x" final_pose="{goal}"/> -->
      <!-- <ModifyGoal original_pose="{goal}" modifying_pose="0;0.05;-0.15" final_pose="{goal}"/>  -->
      <!-- <NavigateToPose server_name="{server_name}" goal="{goal}" yaw_lock="{temp_yaw}"/> -->

      <!-- Replace this with aligning with camera -->

      <!-- Re-acquire proper range -->
      <!-- <RetryUntilSuccesful num_attempts="-1"> -->
        <!-- <Sequence> -->
          <!-- <UpdateDetectedObjects topic_name="{vision_topic_name}" result="{detected_objects}" timeout_sec="20.0" /> -->
          <!-- <SetObjectGoal vision_objects="{detected_objects}" target_identity="{vision_target}" goal="{goal}" absolute_depth="{object_depth}" absolute_yaw="{object_yaw}" /> -->
        <!-- </Sequence> -->
      <!-- </RetryUntilSuccesful> -->
      <!-- <ModifyGoal original_pose="{goal}" zeroed_components="y,z" final_pose="{goal}"/> -->
      <!-- <UpdatePose topic_name="{pose_topic_name}" result="{odom_pose}" depth="{object_depth}"/> -->

      <!-- Move towards vision_main_target's Small Hole -->
      <!-- <Inverter> -->
          <!-- <Timeout msec="30000"> -->
          <!-- <NavigateToPose server_name="{server_name}" goal="{goal}" yaw_lock="{temp_yaw}" depth_lock="{object_depth}"/> -->
          <!-- </Timeout> -->
      <!-- </Inverter> -->

      <!-- Shoots torpedo here -->
      <!-- <Repeat num_cycles="10"> -->
        <!-- <ManipulatorsService -->
        <!-- service_name="/auv3/manipulators" -->
        <!-- top_torpedo="true" -->
        <!-- bottom_torpedo="false" -->
        <!-- dropper="false" grabber="false" extend_linear="false" retract_linear="false" /> -->
      <!-- </Repeat> -->
      
      <!-- Disable Vision -->
      <!-- <DetectorAUVService service_name="{vision_service_name}" objects="bootlegger_small_hole,bootlegger" enable="false"/> -->
    </Sequence>
  </BehaviorTree>
</root>